{% extends "base.html" %}

{% block title %}Страница статуса{% endblock %}

{% block hero_title %}Статус выполнения программы{% endblock %}
{% block hero_description %}Отслеживание прогресса обработки данных в реальном времени{% endblock %}

{% block content %}
<div class="main__container">
    <div class="main__content">
        <div class="main__header">
            <h1 class="main__title">Обработка данных</h1>
            <!--
            <div class="status-indicator status-processing" id="statusIndicator">
                <span id="statusText">В процессе</span>
            </div>
            -->
        </div>

        <!-- Progress Section -->
        <section class="main__section">
            <div class="progress">
                <div class="progress__info">
                    <span class="progress__label">Общий прогресс</span>
                    <span class="progress__percent" id="overallPercent">0%</span>
                </div>
                <div class="progress__bar-container">
                    <div class="progress__bar" id="overallProgressBar"></div>
                </div>
                <div class="progress__phase">
                    Текущий этап: <span class="progress__phase-name" id="currentPhase">Инициализация...</span>
                </div>
            </div>
        </section>
        
        <!-- Timer Section -->
        <section class="main__section">
            <div class="timer">
                <div class="timer__label">Время выполнения:</div>
                <div class="timer__display" id="executionTimer">00:00:00</div>
            </div>
        </section>
        
        <!-- Phase List -->
        <section class="main__section">
            <div class="grid grid--one">
                <div class="card card--phase card--phase-active" id="phase1">
                    <div class="card__content card__content--inline">
                        <div class="card__icon card__icon--active">⟳</div>
                        <div class="card__body">
                            <div class="card__title">Загрузка файла</div>
                            <div class="card__description">Проверка формата и структуры JSON</div>
                        </div>
                        <div class="card__progress" id="phase1Percent">0%</div>
                    </div>
                </div>
                
                <div class="card card--phase card--phase-pending" id="phase2">
                    <div class="card__content card__content--inline">
                        <div class="card__icon card__icon--pending">…</div>
                        <div class="card__body">
                            <div class="card__title">Анализ входных данных</div>
                            <div class="card__description">Парсинг и валидация структуры данных</div>
                        </div>
                        <div class="card__progress" id="phase2Percent">0%</div>
                    </div>
                </div>
                
                <div class="card card--phase card--phase-pending" id="phase3">
                    <div class="card__content card__content--inline">
                        <div class="card__icon card__icon--pending">…</div>
                        <div class="card__body">
                            <div class="card__title">Обработка данных</div>
                            <div class="card__description">Применение алгоритмов анализа</div>
                        </div>
                        <div class="card__progress">0%</div>
                    </div>
                </div>
                
                <div class="card card--phase card--phase-pending" id="phase4">
                    <div class="card__content card__content--inline">
                        <div class="card__icon card__icon--pending">…</div>
                        <div class="card__body">
                            <div class="card__title">Формирование отчета</div>
                            <div class="card__description">Создание итоговых результатов</div>
                        </div>
                        <div class="card__progress">0%</div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Actions -->
        <section class="main__section">
            <div class="action-group">
                <button class="button button--primary" id="pauseResumeBtn">Приостановить</button>
                <button class="button button--secondary" id="cancelBtn">Отменить</button>
            </div>
        </section>
        
        <!-- Log Section -->
        <section class="main__section">
            <div class="content-panel content-panel--compact content-panel--white">
                <div class="content-panel__header">
                    <span class="content-panel__title">Журнал выполнения</span>
                    <button class="content-panel__clear" id="clearLogBtn">Очистить</button>
                </div>
                <div class="content-panel__list content-panel__list--mh300" id="logContent">
                    <!-- Логи будут добавляться здесь динамически -->
                </div>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Элементы DOM
        const overallProgressBar = document.getElementById('overallProgressBar');
        const overallPercent = document.getElementById('overallPercent');
        const currentPhase = document.getElementById('currentPhase');
        const executionTimer = document.getElementById('executionTimer');
        const pauseResumeBtn = document.getElementById('pauseResumeBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const logContent = document.getElementById('logContent');
        const clearLogBtn = document.getElementById('clearLogBtn');
        
        // Переменные состояния
        let startTime = new Date();
        let timerInterval;
        let isPaused = false;
        let progressInterval;
        let currentProgress = 0;
        let phase1Progress = 0;
        let phase2Progress = 0;
        let phase3Progress = 0;
        let phase4Progress = 0;
        
        // Инициализация таймера
        function startTimer() {
            timerInterval = setInterval(updateTimer, 1000);
        }
        
        function updateTimer() {
            if (isPaused) return;
            
            const now = new Date();
            const diff = now - startTime;
            
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            
            executionTimer.textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Имитация прогресса
        function startProgressSimulation() {
            progressInterval = setInterval(updateProgress, 1000);
        }
        
        function updateProgress() {
            if (isPaused) return;
            
            // Обновление прогресса фазы 1
            if (phase1Progress < 100) {
                phase1Progress += Math.floor(Math.random() * 15) + 10;
                if (phase1Progress > 100) phase1Progress = 100;
                
                document.getElementById('phase1Percent').textContent = `${phase1Progress}%`;
                
                if (phase1Progress === 100) {
                    completePhase('phase1');
                    startPhase('phase2');
                    addLogEntry('Загрузка файла завершена', 'success');
                    addLogEntry('Начало анализа входных данных...');
                }
            }
            // Обновление прогресса фазы 2
            else if (phase2Progress < 100) {
                phase2Progress += Math.floor(Math.random() * 10) + 5;
                if (phase2Progress > 100) phase2Progress = 100;
                
                document.getElementById('phase2Percent').textContent = `${phase2Progress}%`;
                
                if (phase2Progress === 100) {
                    completePhase('phase2');
                    startPhase('phase3');
                    addLogEntry('Анализ входных данных завершен', 'success');
                    addLogEntry('Начало обработки данных...');
                }
            }
            // Обновление прогресса фазы 3
            else if (phase3Progress < 100) {
                phase3Progress += Math.floor(Math.random() * 8) + 3;
                if (phase3Progress > 100) phase3Progress = 100;
                
                document.getElementById('phase3').querySelector('.card__progress').textContent = `${phase3Progress}%`;
                
                if (phase3Progress === 100) {
                    completePhase('phase3');
                    startPhase('phase4');
                    addLogEntry('Обработка данных завершена', 'success');
                    addLogEntry('Формирование отчета...');
                }
            }
            // Обновление прогресса фазы 4
            else if (phase4Progress < 100) {
                phase4Progress += Math.floor(Math.random() * 15) + 10;
                if (phase4Progress > 100) phase4Progress = 100;
                
                document.getElementById('phase4').querySelector('.card__progress').textContent = `${phase4Progress}%`;
                
                if (phase4Progress === 100) {
                    completePhase('phase4');
                    finishProcessing();
                }
            }
            
            // Расчет общего прогресса
            const totalPhases = 4;
            const completedPhases = 
                (phase1Progress === 100 ? 1 : 0) + 
                (phase2Progress === 100 ? 1 : 0) + 
                (phase3Progress === 100 ? 1 : 0) + 
                (phase4Progress === 100 ? 1 : 0);
            
            const phaseProgress = 
                (phase1Progress === 100 ? 100 : phase1Progress) +
                (phase2Progress === 100 ? 100 : phase2Progress) +
                (phase3Progress === 100 ? 100 : phase3Progress) +
                (phase4Progress === 100 ? 100 : phase4Progress);
            
            currentProgress = Math.min(100, (completedPhases * 100 + phaseProgress) / (totalPhases * 100) * 100);
            
            // Обновление общего прогресса
            overallProgressBar.style.width = `${currentProgress}%`;
            overallPercent.textContent = `${Math.round(currentProgress)}%`;
            
            // Обновление текущей фазы
            if (phase1Progress < 100) {
                currentPhase.textContent = `Загрузка файла (${phase1Progress}% завершено)`;
            } else if (phase2Progress < 100) {
                currentPhase.textContent = `Анализ входных данных (${phase2Progress}% завершено)`;
            } else if (phase3Progress < 100) {
                currentPhase.textContent = `Обработка данных (${phase3Progress}% завершено)`;
            } else if (phase4Progress < 100) {
                currentPhase.textContent = `Формирование отчета (${phase4Progress}% завершено)`;
            }
        }
        
        function startPhase(phaseId) {
            const phaseElement = document.getElementById(phaseId);
            phaseElement.classList.remove('card--phase-pending');
            phaseElement.classList.add('card--phase-active');
            
            const phaseIcon = phaseElement.querySelector('.card__icon');
            phaseIcon.classList.remove('card__icon--pending');
            phaseIcon.classList.add('card__icon--active');
            phaseIcon.textContent = '⟳';
        }
        
        function completePhase(phaseId) {
            const phaseElement = document.getElementById(phaseId);
            phaseElement.classList.remove('card--phase-active');
            phaseElement.classList.add('card--phase-completed');
            
            const phaseIcon = phaseElement.querySelector('.card__icon');
            phaseIcon.classList.remove('card__icon--active');
            phaseIcon.classList.add('card__icon--completed');
            phaseIcon.textContent = '✓';
        }
        
        function finishProcessing() {
            clearInterval(progressInterval);
            clearInterval(timerInterval);
            
            pauseResumeBtn.disabled = true;
            cancelBtn.disabled = true;
            
            addLogEntry('Обработка данных успешно завершена!', 'success');
            
            // Показать уведомление о завершении
            setTimeout(() => {
                alert('Обработка данных завершена успешно!');
            }, 500);
        }
        
        function addLogEntry(message, type = 'info') {
            const now = new Date();
            const timeString = `[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}]`;
            
            const logEntry = document.createElement('div');
            logEntry.className = `content-panel__item content-panel__item--log ${type === 'success' ? 'content-panel__item--success' : ''} ${type === 'error' ? 'content-panel__item--error' : ''}`;
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'content-panel__time';
            timeSpan.textContent = timeString;
            
            const messageSpan = document.createElement('span');
            messageSpan.className = 'content-panel__message';
            messageSpan.textContent = message;
            
            logEntry.appendChild(timeSpan);
            logEntry.appendChild(messageSpan);
            
            logContent.appendChild(logEntry);
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        // Обработчики событий
        pauseResumeBtn.addEventListener('click', function() {
            isPaused = !isPaused;
            
            if (isPaused) {
                pauseResumeBtn.textContent = 'Продолжить';
                addLogEntry('Обработка приостановлена');
            } else {
                pauseResumeBtn.textContent = 'Приостановить';
                addLogEntry('Обработка возобновлена');
            }
        });
        
        cancelBtn.addEventListener('click', function() {
            if (confirm('Вы уверены, что хотите отменить обработку? Все несохраненные данные будут потеряны.')) {
                clearInterval(progressInterval);
                clearInterval(timerInterval);
                
                pauseResumeBtn.disabled = true;
                cancelBtn.disabled = true;
                
                addLogEntry('Обработка отменена пользователем', 'error');
            }
        });
        
        clearLogBtn.addEventListener('click', function() {
            logContent.innerHTML = '';
            addLogEntry('Журнал очищен');
        });
        
        // Запуск процессов
        startTimer();
        startProgressSimulation();
        addLogEntry('Запуск процесса обработки данных...');
        addLogEntry('Начало загрузки файла...');
    });
</script>
{% endblock %}

{% block extra_css %}
{% endblock %}
