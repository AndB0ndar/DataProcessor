{% extends "base.html" %}

{% block title %}Страница статуса{% endblock %}

{% block hero_title %}Статус выполнения программы{% endblock %}
{% block hero_description %}Отслеживание прогресса обработки данных в реальном времени{% endblock %}

{% block content %}
<div class="main__container">
    <div class="main__content">
        <div class="main__header">
            <h1 class="main__title">Запуск #{{ run.id }} - Статус и прогресс</h1>
            <div class="status-indicator status-{{ run.status.value }}" id="statusIndicator">
                <span id="statusText">{{ run.status.value.upper() }}</span>
            </div>
        </div>

        <section class="main__section">
            <div class="grid grid--four">
                <div class="card card--stat">
                    <div class="card__content card__content--center">
                        <div class="card__title">Прогресс</div>
                        <div class="card__label card__label--large" id="progress">
                            {{ run.progress }}%
                        </div>
                    </div>
                </div>
                
                <div class="card card--stat">
                    <div class="card__content card__content--center">
                        <div class="card__title">Текущий этап</div>
                        <div class="card__label card__label--large" id="current-stage">
                            {{ run.current_stage.value if run.current_stage else 'Ожидание' }}
                        </div>
                    </div>
                </div>
                
                <div class="card card--stat">
                    <div class="card__content card__content--center">
                        <div class="card__title">Длительность</div>
                        <div class="card__label card__label--large" id="duration">
                            {{ run.duration }}
                        </div>
                    </div>
                </div>
                
                <div class="card card--stat">
                    <div class="card__content card__content--center">
                        <div class="card__title">Время начала</div>
                        <div class="card__label card__label--large">
                            {{ run.start_time.strftime('%H:%M:%S') if run.start_time else 'Не начат' }}
                        </div>
                    </div>
                </div>
            </div>
        </section>

        
        <!-- Phase List -->
        <section class="main__section">
            <div class="grid grid--one">
                {% for stage in ['synthesis', 'placement', 'routing', 'timing', 'power', 'finished'] %}
                <div class="card card--phase card--phase-pending" id="phase-{{ stage }}" data-stage="{{ stage }}">
                    <div class="card__content card__content--inline">
                        <div class="card__icon card__icon--pending">…</div>
                        <div class="card__body">
                            <div class="card__title">{{ stage|title }}</div>
                            <div class="card__description" id="desc-{{ stage }}">
                                Ожидание начала...
                            </div>
                        </div>
                        <div class="card__progress" id="time-{{ stage }}">--:--</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        
        <!-- Actions -->
        <section class="main__section" id="cancel-button">
            <form action="{{ url_for('api.cancel_run', run_id=run.id) }}" method="POST" class="d-inline">
                <button type="submit" class="button button--secondary">
                    Отменить выполнение
                </button>
            </form>
        </section>
        
        <!-- Сообщение об ошибке -->
        <section class="main__section" id="error-container" style="display: none;">
            <div class="card card--error">
                <div class="card__header">
                    <span class="card__title">Ошибка выполнения</span>
                </div>
                <div class="card__content">
                    <p>Произошла ошибка при обработке вашего запуска.</p>
                    <a href="{{ url_for('website.logs', run_id=run.id) }}" class="button button--danger">
                        Просмотр журнала ошибок
                    </a>
                </div>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
console.log("Инициализация мониторинга статуса для запуска {{ run.id }}");

let pollInterval = null;
let isFinished = false;
let stageStartTimes = {};

const stageDescriptions = {
    'synthesis': 'Преобразование RTL в сетевой список на уровне вентилей',
    'placement': 'Размещение стандартных ячеек на кристалле',
    'routing': 'Соединение ячеек металлическими проводниками',
    'timing': 'Анализ временных ограничений',
    'power': 'Оптимизация энергопотребления',
    'finished': 'Завершение и генерация отчетов'
};

function updateUI(data) {
    document.getElementById('progress').textContent = data.progress + '%';
    
    document.getElementById('current-stage').textContent = data.current_stage || 'Ожидание';
    
    if (data.duration) {
        document.getElementById('duration').textContent = data.duration;
    }
    
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    
    statusIndicator.className = 'status-indicator';
    if (data.status === 'completed') {
        statusIndicator.classList.add('status-completed');
    } else if (data.status === 'running') {
        statusIndicator.classList.add('status-processing');
    } else if (data.status === 'pending') {
        statusIndicator.classList.add('status-pending');
    } else {
        statusIndicator.classList.add('status-error');
    }
    
    statusText.textContent = data.status.toUpperCase();
    
    updateStages(data.completed_stages, data.current_stage, data.status);
    
    updateElementVisibility(data.status);
}

function updateElementVisibility(status) {
    const cancelButtonContainer = document.querySelector('.action-group');
    const errorContainer = document.getElementById('error-container');
    const resultsNavLink = document.getElementById('results-nav-link');
    const cancelButton = document.getElementById('cancel-button');
    
    // Управление кнопкой отмены
    if (cancelButtonContainer) {
        if (status === 'running' || status === 'pending') {
            cancelButtonContainer.style.display = 'flex';
        } else {
            cancelButtonContainer.style.display = 'none';
        }
    }
    
    // Управление кнопкой результатов и навигационной ссылкой
    if (status === 'completed') {
        if (resultsNavLink) resultsNavLink.style.display = 'inline-flex';
        if (errorContainer) errorContainer.style.display = 'none';
        if (errorContainer) cancelButton.style.display = 'none';
    } 
    // Управление контейнером ошибок
    else if (status === 'failed' || status === 'cancelled') {
        if (resultsNavLink) resultsNavLink.style.display = 'none';
        if (errorContainer) errorContainer.style.display = 'block';
        if (errorContainer) cancelButton.style.display = 'none';
    }
    // Для running/pending скрываем все завершающие элементы
    else {
        if (resultsNavLink) resultsNavLink.style.display = 'none';
        if (errorContainer) errorContainer.style.display = 'none';
    }
    
    // Обработка завершения запуска
    if (status === 'completed' || status === 'failed' || status === 'cancelled') {
        isFinished = true;
        stopPolling();
        console.log(`Запуск ${status}. Опрос остановлен.`);

        //  for base.html
        const resultsNavItem = document.getElementById('results-nav-item');
        if (resultsNavItem) {
            resultsNavItem.classList.remove('header__item--hidden');
        }
    }
}

function updateStages(completedStages, currentStage, overallStatus) {
    const allStages = ['synthesis', 'placement', 'routing', 'timing', 'power', 'finished'];
    
    allStages.forEach(stage => {
        const stageElement = document.getElementById(`phase-${stage}`);
        const stageIcon = stageElement.querySelector('.card__icon');
        const descriptionElement = document.getElementById(`desc-${stage}`);
        const timeElement = document.getElementById(`time-${stage}`);
        
        // Устанавливаем описание
        if (descriptionElement && stageDescriptions[stage]) {
            descriptionElement.textContent = stageDescriptions[stage];
        }
        
        // Определяем статус этапа
        if (completedStages.includes(stage)) {
            setStageStatus(stageElement, stageIcon, 'completed');
            if (timeElement && !timeElement.dataset.completed) {
                timeElement.textContent = getCurrentTime();
                timeElement.dataset.completed = true;
            }
        } else if (stage === currentStage) {
            setStageStatus(stageElement, stageIcon, 'running');
            if (!stageStartTimes[stage]) {
                stageStartTimes[stage] = new Date();
            }
            if (timeElement) {
                timeElement.textContent = 'В процессе...';
            }
        } else {
            setStageStatus(stageElement, stageIcon, 'pending');
            if (timeElement) {
                timeElement.textContent = '--:--';
            }
        }
    });
}

function setStageStatus(stageElement, stageIcon, status) {
    // Сбрасываем все классы
    stageElement.className = 'card card--phase';
    stageIcon.className = 'card__icon';
    
    switch (status) {
        case 'completed':
            stageElement.classList.add('card--phase-completed');
            stageIcon.classList.add('card__icon--completed');
            stageIcon.textContent = '✓';
            break;
        case 'running':
            stageElement.classList.add('card--phase-active');
            stageIcon.classList.add('card__icon--active');
            stageIcon.textContent = '⟳';
            break;
        case 'pending':
            stageElement.classList.add('card--phase-pending');
            stageIcon.classList.add('card__icon--pending');
            stageIcon.textContent = '…';
            break;
    }
}

function getCurrentTime() {
    const now = new Date();
    return now.toLocaleTimeString('ru-RU', { hour12: false, hour: '2-digit', minute: '2-digit' });
}

function stopPolling() {
    if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
    }
}

function startPolling() {
    pollInterval = setInterval(async () => {
        try {
            const response = await fetch(`{{ url_for('api.status', run_id=run.id) }}`);
            const data = await response.json();
            
            if (data.error) {
                console.error('Ошибка получения статуса запуска:', data.error);
                stopPolling();
                return;
            }
            
            updateUI(data);
            
        } catch (error) {
            console.log('Ошибка опроса:', error);
        }
    }, 2000);
}


startPolling();
window.addEventListener('beforeunload', function() {
    stopPolling();
});
window.onload = function() {
    const initialData = {
        completed_stages: {{ run.completed_stages_list | tojson }},
        current_stage: {{ run.current_stage.value | tojson }},
        status: {{ run.status.value | tojson }},
    };
    updateStages(initialData.completed_stages, initialData.current_stage, initialData.status);
    updateElementVisibility(initialData.status);
};
</script>
{% endblock %}

{% block extra_css %}
{% endblock %}
