{% extends "base.html" %}

{% block title %}–°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–∞{% endblock %}

{% block hero_title %}–°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã{% endblock %}
{% block hero_description %}–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏{% endblock %}

{% block content %}
<div class="main__container">
    <div class="main__content">
        <div class="main__header">
            <h1 class="main__title">–ó–∞–ø—É—Å–∫ #{{ run.id }} - –°—Ç–∞—Ç—É—Å –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å</h1>
            <div class="status-indicator status-{{ run.status.value }}" id="statusIndicator">
                <span id="statusText">{{ run.status.value.upper() }}</span>
            </div>
        </div>

        <section class="main__section">
            <div class="grid grid--four">
                <div class="card card--stat">
                    <div class="card__content card__content--center">
                        <div class="card__title">–ü—Ä–æ–≥—Ä–µ—Å—Å</div>
                        <div class="card__label card__label--large" id="progress">
                            {{ run.progress }}%
                        </div>
                    </div>
                </div>
                
                <div class="card card--stat">
                    <div class="card__content card__content--center">
                        <div class="card__title">–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø</div>
                        <div class="card__label card__label--large" id="current-stage">
                            {{ run.current_stage.value if run.current_stage else '–û–∂–∏–¥–∞–Ω–∏–µ' }}
                        </div>
                    </div>
                </div>
                
                <div class="card card--stat">
                    <div class="card__content card__content--center">
                        <div class="card__title">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
                        <div class="card__label card__label--large" id="duration">
                            {{ run.duration }}
                        </div>
                    </div>
                </div>
                
                <div class="card card--stat">
                    <div class="card__content card__content--center">
                        <div class="card__title">–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</div>
                        <div class="card__label card__label--large">
                            {{ run.start_time.strftime('%H:%M:%S') if run.start_time else '–ù–µ –Ω–∞—á–∞—Ç' }}
                        </div>
                    </div>
                </div>
            </div>
        </section>

        
        <!-- Phase List -->
        <section class="main__section">
            <div class="grid grid--one">
                {% for stage in ['synthesis', 'placement', 'routing', 'timing', 'power', 'finished'] %}
                <div class="card card--phase card--phase-pending" id="phase-{{ stage }}" data-stage="{{ stage }}">
                    <div class="card__content card__content--inline">
                        <div class="card__icon card__icon--pending">‚Ä¶</div>
                        <div class="card__body">
                            <div class="card__title">{{ stage|title }}</div>
                            <div class="card__description" id="desc-{{ stage }}">
                                –û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞...
                            </div>
                        </div>
                        <div class="card__progress" id="time-{{ stage }}">--:--</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        
        <!-- Actions -->
        <section class="main__section" id="cancel-button">
            <form action="{{ url_for('api.cancel_run', run_id=run.id) }}" method="POST" class="d-inline">
                <button type="submit" class="button button--secondary">
                    –û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
                </button>
            </form>
        </section>
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
        <section class="main__section" id="error-container" style="display: none;">
            <div class="card card--error">
                <div class="card__header">
                    <span class="card__title">–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</span>
                </div>
                <div class="card__content">
                    <p>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ –∑–∞–ø—É—Å–∫–∞.</p>
                    <a href="{{ url_for('website.logs', run_id=run.id) }}" class="button button--danger">
                        –ü—Ä–æ—Å–º–æ—Ç—Ä –∂—É—Ä–Ω–∞–ª–∞ –æ—à–∏–±–æ–∫
                    </a>
                </div>
            </div>
        </section>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
console.log("üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å—Ç–∞—Ç—É—Å–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ {{ run.id }}");

let pollInterval = null;
let isFinished = false;
let stageStartTimes = {};

const stageDescriptions = {
    'synthesis': '–ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ RTL –≤ —Å–µ—Ç–µ–≤–æ–π —Å–ø–∏—Å–æ–∫ –Ω–∞ —É—Ä–æ–≤–Ω–µ –≤–µ–Ω—Ç–∏–ª–µ–π',
    'placement': '–†–∞–∑–º–µ—â–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö —è—á–µ–µ–∫ –Ω–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª–µ',
    'routing': '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —è—á–µ–µ–∫ –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–º–∏ –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–∞–º–∏',
    'timing': '–ê–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π',
    'power': '–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —ç–Ω–µ—Ä–≥–æ–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è',
    'finished': '–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤'
};

function updateUI(data) {
    document.getElementById('progress').textContent = data.progress + '%';
    
    document.getElementById('current-stage').textContent = data.current_stage || '–û–∂–∏–¥–∞–Ω–∏–µ';
    
    if (data.duration) {
        document.getElementById('duration').textContent = data.duration;
    }
    
    const statusIndicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    
    statusIndicator.className = 'status-indicator';
    if (data.status === 'completed') {
        statusIndicator.classList.add('status-completed');
    } else if (data.status === 'running') {
        statusIndicator.classList.add('status-processing');
    } else if (data.status === 'pending') {
        statusIndicator.classList.add('status-pending');
    } else {
        statusIndicator.classList.add('status-error');
    }
    
    statusText.textContent = data.status.toUpperCase();
    
    updateStages(data.completed_stages, data.current_stage, data.status);
    
    updateElementVisibility(data.status);
}

function updateElementVisibility(status) {
    const cancelButtonContainer = document.querySelector('.action-group');
    const errorContainer = document.getElementById('error-container');
    const resultsNavLink = document.getElementById('results-nav-link');
    const cancelButton = document.getElementById('cancel-button');
    
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–æ–π –æ—Ç–º–µ–Ω—ã
    if (cancelButtonContainer) {
        if (status === 'running' || status === 'pending') {
            cancelButtonContainer.style.display = 'flex';
        } else {
            cancelButtonContainer.style.display = 'none';
        }
    }
    
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω–æ–π —Å—Å—ã–ª–∫–æ–π
    if (status === 'completed') {
        if (resultsNavLink) resultsNavLink.style.display = 'inline-flex';
        if (errorContainer) errorContainer.style.display = 'none';
        if (errorContainer) cancelButton.style.display = 'none';
    } 
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º –æ—à–∏–±–æ–∫
    else if (status === 'failed' || status === 'cancelled') {
        if (resultsNavLink) resultsNavLink.style.display = 'none';
        if (errorContainer) errorContainer.style.display = 'block';
        if (errorContainer) cancelButton.style.display = 'none';
    }
    // –î–ª—è running/pending —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∑–∞–≤–µ—Ä—à–∞—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    else {
        if (resultsNavLink) resultsNavLink.style.display = 'none';
        if (errorContainer) errorContainer.style.display = 'none';
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø—É—Å–∫–∞
    if (status === 'completed' || status === 'failed' || status === 'cancelled') {
        isFinished = true;
        stopPolling();
        console.log(`–ó–∞–ø—É—Å–∫ ${status}. –û–ø—Ä–æ—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.`);
    }
}

function updateStages(completedStages, currentStage, overallStatus) {
    const allStages = ['synthesis', 'placement', 'routing', 'timing', 'power', 'finished'];
    
    allStages.forEach(stage => {
        const stageElement = document.getElementById(`phase-${stage}`);
        const stageIcon = stageElement.querySelector('.card__icon');
        const descriptionElement = document.getElementById(`desc-${stage}`);
        const timeElement = document.getElementById(`time-${stage}`);
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
        if (descriptionElement && stageDescriptions[stage]) {
            descriptionElement.textContent = stageDescriptions[stage];
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —ç—Ç–∞–ø–∞
        if (completedStages.includes(stage)) {
            setStageStatus(stageElement, stageIcon, 'completed');
            if (timeElement && !timeElement.dataset.completed) {
                timeElement.textContent = getCurrentTime();
                timeElement.dataset.completed = true;
            }
        } else if (stage === currentStage) {
            setStageStatus(stageElement, stageIcon, 'running');
            if (!stageStartTimes[stage]) {
                stageStartTimes[stage] = new Date();
            }
            if (timeElement) {
                timeElement.textContent = '–í –ø—Ä–æ—Ü–µ—Å—Å–µ...';
            }
        } else {
            setStageStatus(stageElement, stageIcon, 'pending');
            if (timeElement) {
                timeElement.textContent = '--:--';
            }
        }
    });
}

function setStageStatus(stageElement, stageIcon, status) {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã
    stageElement.className = 'card card--phase';
    stageIcon.className = 'card__icon';
    
    switch (status) {
        case 'completed':
            stageElement.classList.add('card--phase-completed');
            stageIcon.classList.add('card__icon--completed');
            stageIcon.textContent = '‚úì';
            break;
        case 'running':
            stageElement.classList.add('card--phase-active');
            stageIcon.classList.add('card__icon--active');
            stageIcon.textContent = '‚ü≥';
            break;
        case 'pending':
            stageElement.classList.add('card--phase-pending');
            stageIcon.classList.add('card__icon--pending');
            stageIcon.textContent = '‚Ä¶';
            break;
    }
}

function getCurrentTime() {
    const now = new Date();
    return now.toLocaleTimeString('ru-RU', { hour12: false, hour: '2-digit', minute: '2-digit' });
}

function stopPolling() {
    if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
    }
}

function startPolling() {
    pollInterval = setInterval(async () => {
        try {
            const response = await fetch(`{{ url_for('api.status', run_id=run.id) }}`);
            const data = await response.json();
            
            if (data.error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–ø—É—Å–∫–∞:', data.error);
                stopPolling();
                return;
            }
            
            updateUI(data);
            
        } catch (error) {
            console.log('–û—à–∏–±–∫–∞ –æ–ø—Ä–æ—Å–∞:', error);
        }
    }, 2000);
}


startPolling();
window.addEventListener('beforeunload', function() {
    stopPolling();
});
window.onload = function() {
    const initialData = {
        completed_stages: {{ run.completed_stages_list | tojson }},
        current_stage: "{{ run.current_stage.value if run.current_stage else null | tojson }}",
        status: {{ run.status.value | tojson }},
    };
    updateStages(initialData.completed_stages, initialData.current_stage, initialData.status);
    updateElementVisibility(initialData.status);
};
</script>
{% endblock %}

{% block extra_css %}
{% endblock %}
